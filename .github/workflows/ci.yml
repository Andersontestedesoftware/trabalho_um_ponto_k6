name: CI

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Start server (background)
        shell: pwsh
        run: |
          # start node server in background so k6 can run after
          Start-Process -FilePath node -ArgumentList 'server.js' -NoNewWindow -PassThru | Select-Object -ExpandProperty Id | Out-File -Encoding ASCII server.pid
          Start-Sleep -Seconds 1

      # wait a short time to allow the server to start (1 second)
      - name: Short wait after server start
        shell: pwsh
        run: Start-Sleep -Seconds 1

      - name: Install k6 (Chocolatey)
        shell: pwsh
        run: choco install k6 -y

      - name: Run k6 exactly like local
        shell: pwsh
        run: |
          $env:K6_WEB_DASHBOARD = "true"
          $env:K6_WEB_DASHBOARD_EXPORT = "html-report.html"
          k6 run --summary-export=out/summary.json test/k6/trabalho_k6.js

      - name: Upload k6 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: k6-report
          path: |
            out/summary.json
            html-report.html

      - name: Stop server
        if: always()
        shell: pwsh
        run: |
          if (Test-Path server.pid) {
            $pid = (Get-Content server.pid).Trim()
            if ($pid) { Stop-Process -Id $pid -ErrorAction SilentlyContinue }
            Remove-Item server.pid -ErrorAction SilentlyContinue
          }

